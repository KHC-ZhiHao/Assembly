"use strict";var _extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t},_createClass=function(){function o(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(t,e,n){return e&&o(t.prototype,e),n&&o(t,n),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}!function(t,e){"undefined"!=typeof module&&"object"===("undefined"==typeof exports?"undefined":_typeof(exports))?module.exports=e():"function"==typeof define&&(define.amd||define.cmd)?define(function(){return e}):t.Assembly=e()}("undefined"!=typeof window?window:global,function(){var s=function(){function e(t){_classCallCheck(this,e),this.$moduleBase={name:t||"no name"}}return _createClass(e,[{key:"$systemError",value:function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"$_no_error";throw"$_no_error"!==n&&(console.log("%c error : ","color:#FFF; background:red"),console.log(n)),new Error("(☉д⊙)!! Assembly::"+this.$moduleBase.name+" => "+t+" -> "+e)}},{key:"$noKey",value:function(t,e,n){return null==e[n]||(this.$systemError(t,"Name already exists.",n),!1)}},{key:"$verify",value:function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},o={};for(var r in e){var i=e[r];if(i[0]&&null==t[r])return void this.$systemError("verify","Must required",r);null!=t[r]?_typeof(i[1])!==("string"==typeof t[r]&&"#"===t[r][0])||t[r].slice(1)?o[r]=t[r]:this.$systemError("verify","Type("+_typeof(i[1])+") error",r):o[r]=i[1]}return Object.assign(o,n)}},{key:"$protection",value:function(t,e,n,o){var r=this;n[e]=o,Object.defineProperty(t,e,{set:function(){r.$systemError("protection","This key is a private key, can't be change.",e)},get:function(){return n[e]}})}}]),e}(),i=function t(){_classCallCheck(this,t)},t=function(t){function e(){_classCallCheck(this,e);var t=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,"Assembly"));return t.groups={},t.namespace=null,t}return _inherits(e,s),_createClass(e,[{key:"getGroup",value:function(t){return this.groups[t]}},{key:"getTool",value:function(t,e){return this.getGroup(t).getTool(e)}},{key:"getLine",value:function(t,e){return this.getGroup(t).getLine(e)}},{key:"addGroup",value:function(t,e,n){null==this.groups[t]?e instanceof a!=!1?"alone"!==e.mode?(e.create&&e.create(n),this.groups[t]=e):this.$systemError("addGroup","Group is alone.",e):this.$systemError("addGroup","Must group.",e):this.$systemError("addGroup","Name already exists.",t)}},{key:"hasGroup",value:function(t){return!!this.groups[t]}},{key:"hasTool",value:function(t,e){return!!this.getGroup(t).hasTool(e)}},{key:"hasLine",value:function(t,e){return!!this.getGroup(t).hasLine(e)}},{key:"tool",value:function(t,e){return this.getTool(t,e).use()}},{key:"line",value:function(t,e){return this.getLine(t,e).use()}}]),e}(),r=function(t){function r(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1],n=arguments[2];_classCallCheck(this,r);var o=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,"Tool"));return o.id=0,o.user=n||new i,o.used=[],o.store={},o.group=e,o.data=o.$verify(t,{name:[!0,""],create:[!1,function(){}],action:[!0,"#function"],allowDirect:[!1,!0]}),o}return _inherits(r,s),_createClass(r,[{key:"install",value:function(){this.initSystem(),this.argumentLength=this.data.action.length,this.install=null,this.data.create.bind(this.user)(this.store,{group:this.groupCase,include:this.include.bind(this)}),this.exports=this.createExports()}},{key:"initSystem",value:function(){this.system={store:this.store,group:this.groupCase,include:this.include.bind(this)}}},{key:"createExports",value:function(t){return{store:this.getStore.bind(this),direct:this.createLambda(this.direct,"direct",t),action:this.createLambda(this.action,"action",t),promise:this.createLambda(this.promise,"promise",t)}}},{key:"getError",value:function(t){return t||"unknown error"}},{key:"packing",value:function(){return this.createExports([].concat(Array.prototype.slice.call(arguments)))}},{key:"createLambda",value:function(r,i){var s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],a=this;return function(){var t=s.concat([].concat(Array.prototype.slice.call(arguments))),e=null;"action"===i&&("function"==typeof t.slice(-1)[0]?e=t.pop():a.$systemError("createLambda","Action must a callback, no need ? try direct!"));for(var n=new Array(a.argumentLength-3),o=0;o<n.length;o++)n[o]=t[o];return r.bind(a)(n,e)}}},{key:"include",value:function(t){return this.group.getTool(t).use()}},{key:"call",value:function(t,e,n){var o;(o=this.data.action).call.apply(o,[this.user].concat(_toConsumableArray(t),[this.system,e,n]))}},{key:"direct",value:function(t){var e=this;!1===this.data.allowDirect&&this.$systemError("direct","Not allow direct.",this.data.name);var n=null;return this.call(t,function(t){throw new Error(e.getError(t))},function(t){n=t}),n}},{key:"action",value:function(t){var e=this,n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:function(){};this.call(t,function(t){n(e.getError(t),null)},function(t){n(null,t)})}},{key:"promise",value:function(n){var o=this;return new Promise(function(t,e){o.call(n,function(t){e(o.getError(t))},t)})}},{key:"getStore",value:function(t){if(this.store[t])return this.store[t];this.$systemError("getStore","Key not found.",t)}},{key:"use",value:function(){return this.install&&this.install(),_extends({},this.exports,{packing:this.packing.bind(this)})}},{key:"name",get:function(){return this.data.name}},{key:"groupCase",get:function(){return this.group.case}}]),r}(),o=function(t){function o(t,e){_classCallCheck(this,o);var n=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,"Line"));return n.group=e,n.data=n.$verify(t,{name:[!0,""],fail:[!0,"#function"],input:[!0,"#function"],output:[!0,"#function"],inlet:[!1,[]],layout:[!0,{}]}),n.inlet=n.data.inlet||null,n.tools={},n.checkPrivateKey(),n}return _inherits(o,s),_createClass(o,[{key:"checkPrivateKey",value:function(){var t=this.data.layout;(t.action||t.promise)&&this.$systemError("init","Layout has private key(action, promise)")}},{key:"use",value:function(){var t=this;return function(){return new e(t,[].concat(Array.prototype.slice.call(arguments))).getConveyer()}}},{key:"name",get:function(){return this.data.name}}]),o}(),e=function(t){function o(t,e){_classCallCheck(this,o);var n=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,"Unit"));return n.case=new i,n.flow=[],n.main=t,n.stack=[],n.index=0,n.layout=t.data.layout,n.params=e,n.previousFlow=null,n.init(),n}return _inherits(o,s),_createClass(o,[{key:"createTool",value:function(t,e){return new r({name:t,action:e},this.main.group,this.case)}},{key:"init",value:function(){this.input=this.createTool("input",this.main.data.input).use(),this.output=this.createTool("output",this.main.data.output).use(),this.initConveyer()}},{key:"initConveyer",value:function(){var e=this,n=this;this.conveyer={action:this.action.bind(this),promise:this.promise.bind(this)};var t=function(t){e.conveyer[t]=function(){return n.register(t,[].concat(Array.prototype.slice.call(arguments))),n.getConveyer()}};for(var o in this.layout)t(o)}},{key:"getConveyer",value:function(){return this.conveyer}},{key:"register",value:function(t,e){0!==this.main.inlet.length&&0===this.flow.length&&(this.main.inlet.includes(t)||this.$systemError("register","First call method not inside inlet.",t));var n={name:t,index:this.index,method:this.createTool(t,this.layout[t]).use(),params:e,nextFlow:null,previous:this.flow.slice(-1)};this.previousFlow&&(this.previousFlow.nextFlow=n),this.previousFlow=n,this.index+=1,this.flow.push(n)}},{key:"include",value:function(t){return this.main.group.getTool(t).use()}},{key:"action",value:function(e){var n=this;this.process(function(t){n.main.fail(t,function(t){e(t,null)})},function(t){e(null,t)})}},{key:"promise",value:function(){var t=this;return new Promise(function(n,o){t.action(function(t,e){t?o(t):n(e)})})}},{key:"process",value:function(t,e){new n(this.params,this.flow,this.input,this.output).start(t,e)}}]),o}(),n=function(t){function i(t,e,n,o){_classCallCheck(this,i);var r=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,"Process"));return r.material=t,r.stop=!1,r.flow=e,r.index=0,r.stack=[],r.input=n,r.output=o,r}return _inherits(i,s),_createClass(i,[{key:"start",value:function(t,e){var n,o=this;this.error=t,this.success=e,this.stack.push("input"),(n=this.input).action.apply(n,_toConsumableArray(this.material).concat([function(t){t?o.fail(t):o.next()}]))}},{key:"finish",value:function(){var n=this;this.stack.push("output"),this.output.action(function(t,e){t?n.fail(t):n.success(e)})}},{key:"createError",value:function(t){return{message:t||"unknown error",stack:this.stack}}},{key:"fail",value:function(t){!1===this.stop&&(this.stop=!0,this.error(this.createError(t)))}},{key:"next",value:function(){var t,e=this,n=this.flow[this.index];n&&!1===this.stop?(this.stack.push(n.name),(t=n.method).action.apply(t,_toConsumableArray(n.params).concat([function(t){t?e.fail(t):(e.index+=1,e.next())}]))):!1===this.stop&&this.finish()}}]),i}(),a=function(t){function n(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,"Group"));return e.case=new i,e.line={},e.mode="factory",e.toolbox={},e.data=e.$verify(t,{create:[!1,function(){}]}),e}return _inherits(n,s),_createClass(n,[{key:"alone",value:function(t){if("alone"!==this.mode)return this.mode="alone",this.create(t),{tool:this.callTool.bind(this),line:this.callLine.bind(this)};this.$systemError("alone","Alone only use once, try function() { return new Group() }.")}},{key:"create",value:function(t){this.data.create.bind(this.case)(t),this.create=null}},{key:"getTool",value:function(t){if(this.toolbox[t])return this.toolbox[t];this.$systemError("getTool","Tool not found.",t)}},{key:"getLine",value:function(t){if(this.line[t])return this.line[t];this.$systemError("getLine","Line not found.",t)}},{key:"callTool",value:function(t){return this.getTool(t).use()}},{key:"callLine",value:function(t){return this.getLine(t).use()}},{key:"addLine",value:function(t){var e=new o(t,this);this.$noKey("currying",this.line,e.name)&&(this.line[e.name]=e)}},{key:"addTool",value:function(t){var e=new r(t,this);this.$noKey("addTool",this.toolbox,e.name)&&(this.toolbox[e.name]=e)}},{key:"hasLine",value:function(t){return!!this.line[t]}},{key:"hasTool",value:function(t){return!!this.toolbox[t]}}]),n}(),u=t;return u.Group=a,u});